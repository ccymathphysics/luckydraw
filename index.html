<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lucky Draw Pro</title>
    <style>
        /* --- 1. æ ¸å¿ƒè§†è§‰æ ·å¼ --- */
        :root {
            --bg-color: #0f172a;
            --accent: #6366f1;
            --accent-glow: rgba(99, 102, 241, 0.5);
            --gold: #fbbf24;
            --text-white: #f1f5f9;
            --text-dim: #94a3b8;
            --panel-bg: rgba(30, 41, 59, 0.95);
        }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            background-image: radial-gradient(circle at 50% 30%, #312e81, #0f172a);
            color: var(--text-white);
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        /* --- 2. é¡¶éƒ¨å¯¼èˆª --- */
        .header {
            padding: 15px 25px;
            background: rgba(0,0,0,0.2);
            backdrop-filter: blur(5px);
            display: flex; justify-content: space-between; align-items: center;
            z-index: 10;
        }
        .brand { font-size: 1.2rem; font-weight: 300; letter-spacing: 1px; display: flex; gap: 10px; align-items: center; }
        .toolbar { display: flex; gap: 10px; }
        
        .btn-icon {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            color: white; padding: 6px 12px; border-radius: 6px; cursor: pointer;
            font-size: 14px; transition: all 0.2s;
        }
        .btn-icon:hover { background: rgba(255,255,255,0.2); }

        /* --- 3. ä¸»èˆå°åŒºåŸŸ --- */
        .stage {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            position: relative; padding-bottom: 60px;
        }

        /* æŠ½å¥–æ˜¾ç¤ºæ¡† */
        .display-box {
            width: 85%; max-width: 1000px;
            height: 40vh;
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 24px;
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 40px;
            box-shadow: 0 0 30px rgba(0,0,0,0.3);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            padding: 0 20px; overflow: hidden;
        }

        /* æ–‡å­—æ ¸å¿ƒæ ·å¼ */
        #resultText {
            font-weight: bold; text-align: center; line-height: 1.2;
            transition: font-size 0.2s ease-out;
            word-break: break-all; 
        }

        /* é€‰ä¸­æ€ç‰¹æ•ˆ */
        .display-box.active {
            border-color: var(--gold);
            background: rgba(255,255,255,0.1);
            box-shadow: 0 0 60px rgba(251, 191, 36, 0.4);
            transform: scale(1.02);
        }
        .display-box.active #resultText {
            color: var(--gold);
            text-shadow: 0 0 20px rgba(251, 191, 36, 0.6);
        }

        /* --- 4. æŒ‰é’®ç»„ --- */
        .btn-main {
            width: 120px; height: 120px;
            border-radius: 50%; border: none;
            color: white; font-size: 24px; font-weight: bold;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transition: transform 0.1s, box-shadow 0.2s;
            display: flex; align-items: center; justify-content: center;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .btn-main:active { transform: scale(0.95); }
        
        .start { background: linear-gradient(135deg, #6366f1, #4f46e5); }
        .start:hover { box-shadow: 0 0 40px var(--accent-glow); }
        
        .stop { background: linear-gradient(135deg, #f43f5e, #be123c); display: none; }
        .stop:hover { box-shadow: 0 0 40px rgba(244, 63, 94, 0.5); }

        /* --- 5. åº•éƒ¨ä¸­å¥–åå• --- */
        .winner-bar {
            position: fixed; bottom: 20px; width: 90%; max-width: 1200px;
            background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px; padding: 15px; text-align: center;
            backdrop-filter: blur(10px);
        }
        .bar-header { 
            font-size: 14px; color: var(--text-dim); margin-bottom: 10px; 
            display: flex; justify-content: center; gap: 15px;
        }
        .tag-list {
            display: flex; justify-content: center; flex-wrap: wrap; gap: 8px;
            max-height: 80px; overflow-y: auto;
        }
        .tag-list::-webkit-scrollbar { width: 0; }
        
        .tag {
            background: rgba(251, 191, 36, 0.15); color: var(--gold); border: 1px solid rgba(251, 191, 36, 0.3);
            padding: 4px 12px; border-radius: 20px; font-size: 14px;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* --- 6. ä¾§è¾¹æ  --- */
        .drawer {
            position: fixed; top: 0; right: -400px; width: 360px; height: 100%;
            background: var(--panel-bg); 
            box-shadow: -10px 0 40px rgba(0,0,0,0.8);
            transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 25px; display: flex; flex-direction: column; box-sizing: border-box; z-index: 100;
        }
        .drawer.open { right: 0; }
        
        .drawer-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; }
        .drawer-head h3 { margin: 0; font-weight: 500; }
        
        textarea {
            flex: 1; background: #0f172a; border: 1px solid #334155; color: var(--text-white);
            padding: 15px; border-radius: 8px; resize: none; font-family: inherit; font-size: 14px;
            margin-bottom: 15px;
        }
        textarea:focus { outline: 2px solid var(--accent); }

        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .btn-full { grid-column: span 2; }
        
        .btn-action {
            padding: 10px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05);
            color: white; border-radius: 6px; cursor: pointer; font-size: 13px;
        }
        .btn-action:hover { background: rgba(255,255,255,0.1); }
        .btn-danger { background: rgba(220, 38, 38, 0.2); border-color: rgba(220, 38, 38, 0.5); color: #fca5a5; }
        .btn-danger:hover { background: rgba(220, 38, 38, 0.4); }

        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 99; display: none; backdrop-filter: blur(2px); }
        .overlay.show { display: block; }
        #fileInput { display: none; }
    </style>
</head>
<body>

<div class="header">
    <div class="brand">
        <span>âœ¨</span> <span data-i18n="appTitle">LUCKY DRAW</span>
    </div>
    <div class="toolbar">
        <button class="btn-icon" onclick="toggleLang()" id="langBtn">EN / ä¸­æ–‡</button>
        <button class="btn-icon" onclick="toggleFullScreen()" data-i18n="btnFullscreen">â›¶ å…¨å±</button>
        <button class="btn-icon" onclick="toggleDrawer()" data-i18n="btnSettings">âš™ï¸ è®¾ç½®</button>
    </div>
</div>

<div class="stage">
    <div class="display-box" id="box">
        <div id="resultText" data-i18n="ready">å‡†å¤‡å°±ç»ª</div>
    </div>

    <button class="btn-main start" id="btnStart" onclick="start()" data-i18n="btnStart">å¼€å§‹</button>
    <button class="btn-main stop" id="btnStop" onclick="stop()" data-i18n="btnStop">åœæ­¢</button>

    <div class="winner-bar">
        <div class="bar-header">
            <span id="poolCount">æ± ä¸­: 0</span>
            <span>|</span>
            <span style="cursor: pointer; color: var(--gold);" onclick="exportWinners()" data-i18n="btnExportWin">ğŸ“¥ å¯¼å‡ºä¸­å¥–è€…</span>
            <span>|</span>
            <span style="cursor: pointer; text-decoration: underline;" onclick="clearWinners()" data-i18n="btnClearWin">æ¸…ç©ºè®°å½•</span>
        </div>
        <div class="tag-list" id="winnerList"></div>
    </div>
</div>

<div class="overlay" id="overlay" onclick="toggleDrawer()"></div>
<div class="drawer" id="drawer">
    <div class="drawer-head">
        <h3 data-i18n="settingsTitle">åå•è®¾ç½®</h3>
        <span onclick="toggleDrawer()" style="cursor:pointer; padding:5px;">âœ•</span>
    </div>

    <div class="btn-group">
        <button class="btn-action" onclick="document.getElementById('fileInput').click()" data-i18n="btnImport">ğŸ“‚ å¯¼å…¥æ–‡ä»¶</button>
        <button class="btn-action" onclick="exportPool()" data-i18n="btnExportPool">ğŸ’¾ å¤‡ä»½åå•</button>
        <input type="file" id="fileInput" accept=".txt,.csv" onchange="handleFileImport(this)">
    </div>

    <p style="color:var(--text-dim); font-size:12px; margin:0 0 5px 0;" data-i18n="inputTip">æ‰‹åŠ¨ç¼–è¾‘ (ä¸€è¡Œä¸€ä¸ª, è‡ªåŠ¨ä¿å­˜)</p>
    <textarea id="nameInput" spellcheck="false" oninput="saveData()"></textarea>

    <label style="display:flex; align-items:center; color: var(--text-white); margin-bottom: 20px; font-size: 14px; cursor: pointer;">
        <input type="checkbox" id="chkRemove" onchange="saveData()" style="width:16px; height:16px; margin-right:8px; accent-color: var(--accent);">
        <span data-i18n="chkRemove">ä¸­å¥–åä»æ± ä¸­ç§»é™¤</span>
    </label>

    <div class="btn-group">
        <button class="btn-action btn-danger btn-full" onclick="resetAll()" data-i18n="btnReset">âš ï¸ å½»åº•æ¸…é™¤æœ¬é¡µç—•è¿¹</button>
    </div>
</div>

<script>
    /* --- 0. é»˜è®¤åå•é…ç½® --- */
    const DEFAULT_POEM = `é†‰é‡ŒæŒ‘ç¯çœ‹å‰‘
æ¢¦å›å¹è§’è¿è¥
å…«ç™¾é‡Œåˆ†éº¾ä¸‹ç‚™
äº”åå¼¦ç¿»å¡å¤–å£°
æ²™åœºç§‹ç‚¹å…µ
é©¬ä½œçš„å¢é£å¿«
å¼“å¦‚éœ¹é›³å¼¦æƒŠ
äº†å´å›ç‹å¤©ä¸‹äº‹
èµ¢å¾—ç”Ÿå‰èº«åå
å¯æ€œç™½å‘ç”Ÿ`;

    /* --- 1. å¤šè¯­è¨€é…ç½® --- */
    const i18nData = {
        zh: {
            appTitle: "æ²™åœºç§‹ç‚¹å…µ",
            ready: "å°±ç»ª",
            btnFullscreen: "â›¶ å…¨å±",
            btnSettings: "âš™ï¸ è®¾ç½®",
            btnStart: "å¼€å§‹",
            btnStop: "åœæ­¢",
            btnExportWin: "ğŸ“¥ å¯¼å‡ºä¸­å¥–",
            btnClearWin: "æ¸…ç©ºè®°å½•",
            settingsTitle: "åå•ç®¡ç†",
            btnImport: "ğŸ“‚ å¯¼å…¥ TXT",
            btnExportPool: "ğŸ’¾ å¤‡ä»½åå•",
            inputTip: "åå•ç¼–è¾‘åŒº (æ¯è¡Œä¸€ä¸ªåå­—)",
            chkRemove: "ä¸­å¥–åä»åå•æ± ç§»é™¤",
            btnReset: "âš ï¸ å½»åº•æ¸…é™¤æœ¬é¡µç—•è¿¹", // æ›´æ–°
            poolCount: "æ± ä¸­äººæ•°: ",
            alertEmpty: "åå•æ± ä¸ºç©ºï¼è¯·å…ˆå¯¼å…¥æˆ–è¾“å…¥åå•ã€‚",
            alertClearWin: "ç¡®å®šè¦æ¸…ç©ºä¸‹æ–¹å·²ä¸­å¥–çš„è®°å½•å—ï¼Ÿ",
            alertReset: "âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°†å½»åº•æ¸…é™¤æœ¬é¡µé¢çš„æ‰€æœ‰æœ¬åœ°ç¼“å­˜ï¼ˆåŒ…æ‹¬åå•ã€è®¾ç½®ã€å†å²è®°å½•ï¼‰ï¼Œé¡µé¢å°†æ¢å¤åˆ°åˆå§‹çŠ¶æ€ã€‚\n\nç¡®å®šæ‰§è¡Œå—ï¼Ÿ", // æ›´æ–°
            importSuccess: "æˆåŠŸå¯¼å…¥åå•ï¼æ•°é‡ï¼š",
            placeholder: DEFAULT_POEM
        },
        en: {
            appTitle: "LUCKY DRAW",
            ready: "READY",
            btnFullscreen: "â›¶ Full",
            btnSettings: "âš™ï¸ Setup",
            btnStart: "GO",
            btnStop: "STOP",
            btnExportWin: "ğŸ“¥ Export Winners",
            btnClearWin: "Clear History",
            settingsTitle: "Settings",
            btnImport: "ğŸ“‚ Import TXT",
            btnExportPool: "ğŸ’¾ Backup List",
            inputTip: "Edit List (One name per line)",
            chkRemove: "Remove winner from pool",
            btnReset: "âš ï¸ Erase All Traces", // Update
            poolCount: "Pool: ",
            alertEmpty: "Pool is empty! Please import list first.",
            alertClearWin: "Clear all winner history?",
            alertReset: "âš ï¸ WARNING: This will completely wipe all local storage traces (Lists, Settings, History) for this page.\n\nAre you sure?", // Update
            importSuccess: "Imported successfully! Count: ",
            placeholder: "Item A\nItem B\nItem C"
        }
    };

    let currentLang = 'zh';
    let names = [];
    let winners = [];
    let timer = null;
    let isRolling = false;

    const els = {
        box: document.getElementById('box'),
        text: document.getElementById('resultText'),
        input: document.getElementById('nameInput'),
        tags: document.getElementById('winnerList'),
        count: document.getElementById('poolCount'),
        chk: document.getElementById('chkRemove'),
        btnStart: document.getElementById('btnStart'),
        btnStop: document.getElementById('btnStop')
    };

    window.onload = () => {
        const savedLang = localStorage.getItem('d_lang');
        if (savedLang) currentLang = savedLang;
        loadData();
        applyLang();
    };

    function toggleLang() {
        currentLang = currentLang === 'zh' ? 'en' : 'zh';
        localStorage.setItem('d_lang', currentLang);
        applyLang();
    }

    function applyLang() {
        const t = i18nData[currentLang];
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (t[key]) el.innerText = t[key];
        });
        if (!isRolling) els.btnStart.innerText = t.btnStart;
        else els.btnStop.innerText = t.btnStop;
        updateCountDisplay();
    }

    // --- æ•°æ®åŠ è½½ ---
    function loadData() {
        const savedNames = localStorage.getItem('d_names_pro');
        const savedWinners = localStorage.getItem('d_winners_pro');
        const savedChk = localStorage.getItem('d_chk_pro');

        if (savedNames) {
            els.input.value = savedNames;
        } else {
            els.input.value = i18nData[currentLang].placeholder;
            saveData();
        }

        if (savedWinners) {
            winners = JSON.parse(savedWinners);
            renderWinners();
        }

        if (savedChk === 'true') els.chk.checked = true;
        
        syncNames();
        adaptFont(els.text.innerText);
    }

    function syncNames() {
        const raw = els.input.value;
        const list = raw.split('\n').map(x => x.trim()).filter(x => x);
        if (els.chk.checked) {
            names = list.filter(n => !winners.includes(n));
        } else {
            names = list;
        }
        updateCountDisplay();
    }

    function updateCountDisplay() {
        els.count.innerText = i18nData[currentLang].poolCount + names.length;
    }

    function saveData() {
        localStorage.setItem('d_names_pro', els.input.value);
        localStorage.setItem('d_chk_pro', els.chk.checked);
        syncNames();
    }

    // --- æ–‡ä»¶å¯¼å…¥å¯¼å‡º ---
    function handleFileImport(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const content = e.target.result;
            if (els.input.value.trim() !== "") {
                if(confirm("è¿½åŠ åˆ°ç°æœ‰åå•(OK) è¿˜æ˜¯ è¦†ç›–ç°æœ‰åå•(Cancel)?")) {
                    els.input.value += "\n" + content;
                } else {
                    els.input.value = content;
                }
            } else {
                els.input.value = content;
            }
            saveData();
            alert(i18nData[currentLang].importSuccess + content.split('\n').length);
            input.value = '';
        };
        reader.readAsText(file);
    }

    function downloadFile(content, filename) {
        const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    function exportWinners() {
        if (winners.length === 0) return;
        downloadFile(winners.join('\n'), `Winners_${new Date().toISOString().slice(0,10)}.txt`);
    }

    function exportPool() {
        downloadFile(els.input.value, `Pool_Backup_${new Date().toISOString().slice(0,10)}.txt`);
    }

    // --- æŠ½å¥–é€»è¾‘ ---
    function adaptFont(text) {
        let len = 0;
        for (let i = 0; i < text.length; i++) {
            len += text.charCodeAt(i) > 255 ? 2 : 1;
        }
        // å­—å·é€‚é…é€»è¾‘ (æ•°å­—è¶Šå°å­—è¶Šå¤§)
        if (len <= 8) els.text.style.fontSize = "10vw";       
        else if (len <= 16) els.text.style.fontSize = "8vw";  
        else if (len <= 24) els.text.style.fontSize = "6vw";  
        else if (len <= 40) els.text.style.fontSize = "4vw";  
        else els.text.style.fontSize = "3vw";                 
    }

    function start() {
        if (names.length === 0) {
            alert(i18nData[currentLang].alertEmpty);
            toggleDrawer();
            return;
        }
        isRolling = true;
        els.btnStart.style.display = 'none';
        els.btnStop.style.display = 'flex';
        els.box.classList.remove('active');

        els.text.style.fontSize = "6vw"; // æ»šåŠ¨æ—¶å›ºå®šå­—å·

        timer = setInterval(() => {
            const r = names[Math.floor(Math.random() * names.length)];
            els.text.innerText = r;
        }, 50);
    }

    function stop() {
        if (!isRolling) return;
        clearInterval(timer);
        isRolling = false;

        els.btnStart.style.display = 'flex';
        els.btnStop.style.display = 'none';

        const finalName = names[Math.floor(Math.random() * names.length)];
        els.text.innerText = finalName;
        adaptFont(finalName);

        els.box.classList.add('active');
        winners.push(finalName);
        localStorage.setItem('d_winners_pro', JSON.stringify(winners));
        renderWinners();
        if (els.chk.checked) syncNames();
    }

    function renderWinners() {
        els.tags.innerHTML = winners.slice().reverse().map(w => `<div class="tag">${w}</div>`).join('');
    }

    function clearWinners() {
        if(winners.length === 0) return;
        if(confirm(i18nData[currentLang].alertClearWin)) {
            winners = [];
            localStorage.setItem('d_winners_pro', '[]');
            renderWinners();
            syncNames();
            els.box.classList.remove('active');
            els.text.innerText = i18nData[currentLang].ready;
            adaptFont("READY");
        }
    }

    // --- å½»åº•æ¸…é™¤ç—•è¿¹é€»è¾‘ ---
    function resetAll() {
        if(confirm(i18nData[currentLang].alertReset)) {
            // 1. æ¸…ç©º LocalStorage (æ ¸å¿ƒæ•°æ®)
            localStorage.clear();
            
            // 2. æ¸…ç©º SessionStorage (ä¼šè¯æ•°æ®)
            sessionStorage.clear();
            
            // 3. æ¸…ç©º Cookie (é˜²å¾¡æ€§æ¸…é™¤ï¼Œè™½ç„¶æœ¬ä»£ç æœªæ˜¾å¼ä½¿ç”¨Cookie)
            document.cookie.split(";").forEach(function(c) { 
                document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
            });

            // 4. åˆ·æ–°é¡µé¢æ¢å¤åˆå§‹çŠ¶æ€
            location.reload();
        }
    }

    function toggleDrawer() {
        document.getElementById('drawer').classList.toggle('open');
        document.getElementById('overlay').classList.toggle('show');
    }

    function toggleFullScreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(e=>{});
        } else {
            document.exitFullscreen();
        }
    }
</script>

</body>
</html>